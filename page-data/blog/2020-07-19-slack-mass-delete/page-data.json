{"componentChunkName":"component---src-components-blog-layout-js","path":"/blog/2020-07-19-slack-mass-delete/","webpackCompilationHash":"9f453edd3eebfb1e54e2","result":{"data":{"mdx":{"id":"931d7ce2-212e-5d39-917b-4b594c672ea0","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Mass Delete Messages on Slack\",\n  \"date\": \"2020-07-19T00:00:00.000Z\"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"My team had a channel on Slack that was rarely used. There was just a Twitter Slack app that would post tweets made by our company's official Twitter account.\\nWe wanted to bring that channel back to life, and also get rid of all the tweets. Removing the Twitter app from the channel was easy, but there was no way to get rid of all the messages it had posted.\\nThe app had been posting multiple tweets a day for almost 2 years, so manually deleting each message was not feasible. Deleting the channel and creating it again with the same name was not an option either - we didn't want to invite all the members again and lose all the messages other members had posted before the Twitter app took over!\"), mdx(\"p\", null, \"I started looking for utilities that would help me delete all posts made by the Twitter app. I tried chrome extensions and command line utilities. Unfortunately, none of them worked. So I decided to use the Slack API to delete the messages using a script.\"), mdx(\"p\", null, \"To use the Slack API, I had to create a Slack App and install it in my workspace. However, since we are on a Slack enterprise grid, an app manager first has to approve my app before I can install it and use it to delete messages. Usually, I am a very patient person. But this time, I did not feel like waiting for an arbitrary amount of time for an approval.\"), mdx(\"p\", null, \"After playing around with Slack for some time in the browser, I noticed that you can use the cookie and the token to authenticate yourself using the API.\\nYou can get these values by looking at the details of an authenticated call in the Network tab in Chrome's DevTools.\"), mdx(Image, {\n    name: \"slack_auth.png\",\n    mdxType: \"Image\"\n  }), mdx(\"p\", null, \"I wrote the following code to fetch all the messages in the channel, and delete those that were posted by the Twitter app. Since the Slack API returns pages of results, I had to handle getting the next page of results as well.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-typescript\"\n  }), \"// slack-cleaner.ts\\n\\nconst HISTORY_ENDPOINT = 'https://<workspace-name>.slack.com/api/conversations.history';\\nconst DELETE_ENDPOINT = 'https://<workspace-name>.slack.com/api/chat.delete';\\n\\nconst COOKIE = Deno.env.get('COOKIE') || '';\\nconst TOKEN = Deno.env.get('TOKEN') || '';\\n\\nconst CHANNEL = '<channel-id>';\\n\\nconst TWITTER_BOT_ID = '<slack-app-id>';\\n\\nconst payload = new FormData();\\npayload.set('token', TOKEN);\\npayload.set('channel', CHANNEL);\\n\\n// Keep track of cursor to fetch next page of results\\nlet next_cursor = '';\\n\\nconst runDeleteLoop = async () => {\\n  payload.set('cusor', next_cursor);\\n  const res = await fetch(HISTORY_ENDPOINT, {\\n    method: 'POST',\\n    body: payload,\\n    headers: {\\n      Cookie: COOKIE,\\n    },\\n  });\\n\\n  const resJson = await res.json();\\n  const messages = resJson.messages;\\n  next_cursor = resJson.response_metadata?.next_cursor;\\n  const messagesFromTwitterBot = messages.filter(\\n    (message: any) =>\\n      message.bot_id === TWITTER_BOT_ID && message.subtype === 'bot_message'\\n  );\\n\\n  console.log(`Total messages: ${messages.length}`);\\n  console.log(`Twitter bot messages: ${messagesFromTwitterBot.length}`);\\n\\n  const interval = setInterval(async () => {\\n    if (messagesFromTwitterBot.length === 0) {\\n      clearInterval(interval);\\n      if (next_cursor !== '') {\\n        console.log(`Starting next page...`);\\n        await runDeleteLoop();\\n      } else {\\n        console.log(`Cleanup completed!`);\\n      }\\n      return;\\n    }\\n    const message = messagesFromTwitterBot.shift();\\n    payload.set('ts', message.ts);\\n    const res = await fetch(DELETE_ENDPOINT, {\\n      method: 'POST',\\n      body: payload,\\n      headers: {\\n        Cookie: COOKIE,\\n      },\\n    });\\n    console.log(res.status, res.statusText);\\n  }, 1000); // The delete endpoint has a Tier 3 rate limit. Approx. 1 request per second ensures we don't hit the rate limit\\n};\\n\\nawait runDeleteLoop();\\n\")), mdx(\"p\", null, \"This can then be run using \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Deno\"), \" after setting the COOKIE and TOKEN environment variables as follows:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-shell\"\n  }), \"$ deno run --allow-net --allow-env slack-cleaner.ts\\n\")), mdx(\"p\", null, \"If you have not provided the cookie and token correctly, the API will return something like this:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-json\"\n  }), \"{\\n  \\\"ok\\\": false,\\n  \\\"error\\\": \\\"not_authed\\\"\\n}\\n\")), mdx(\"p\", null, \"Life would be much easier if Slack provided a feature to mass delete messages from a channel, at least for:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Messages you have posted.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Messages posted by a Slack App.\")));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"title":"Mass Delete Messages on Slack"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"931d7ce2-212e-5d39-917b-4b594c672ea0"}}}